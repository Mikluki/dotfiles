### QOL ###
set -g mouse on

setw -g automatic-rename on
set -g default-terminal "screen-256color"
set -ga terminal-overrides ',*:Ss=\E[%p1%d q:Se=\E[2 q'

set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'

### CLIPBOARD ###
# OSC 52 clipboard integration 
set -g set-clipboard on
set -g allow-passthrough on
set -as terminal-features ',*:clipboard'

# Ensure proper terminal detection for Kitty
set-option -sa terminal-overrides ",xterm-kitty:RGB"
set-option -sa terminal-overrides ",xterm-kitty:Tc"
set-option -sa terminal-overrides ",xterm-kitty:clipboard"

# Copy current path using OSC 52 via yank script
unbind c
bind c \
  run-shell 'tmux set-buffer "#{pane_current_path}"; tmux display-message "Copied: #{pane_current_path}"' \; \
  run-shell 'tmux save-buffer - | yank > #{pane_tty}'

# Configure tmux-yank plugin to use yank script
set -g @yank_action 'copy-pipe-and-cancel'
set -g @yank_selection 'clipboard'
set -g @yank_selection_mouse 'clipboard'
set -g @override_copy_command 'yank > #{pane_tty}'

# Built in copying
bind Space copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle \; send-keys -X begin-selection

### VISUAL ###
# Update terminal window title with the tmux session name
set-option -g set-titles on
set-option -g set-titles-string '#S'
set-option -g set-titles-string '#S: #W'
# set-option -g set-titles-string '#S:#{pane_current_path}'

# enable Yazi image preview
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# Set prefix
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# Zero-out escape time delay for quicker response
# set -s escape-time 0

# Vim style pane navigation
unbind C-Right
unbind C-Left

unbind h
unbind j
unbind k
unbind l
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind -r m resize-pane -Z      # maximazi pane
bind -n F11 resize-pane -Z      # maximazi pane

# Show time 
bind BSpace clock-mode

# Jumping
bind Enter last-window

# hide tmux UI
bind t set -g status

# Close keymaps
bind r source-file ~/.config/tmux/tmux.conf \; display-message "~/.config/tmux/tmux.conf reloaded"
bind X kill-window
bind x kill-pane
bind q kill-pane

# New window
bind a new-window -a -c "#{pane_current_path}"
# Switch windows
bind -n M-u prev
bind -n M-i next

# Switch sessions
bind -n F1 switch-client -p
bind -n F2 switch-client -n


# Start windows and panes at 1, not 0
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on

# Vim style pane swapping
bind -n S-home swap-pane -U
bind -n S-end swap-pane -D

# Vim style pane resize
bind -r -T prefix   K    resize-pane -U
bind -r -T prefix   J    resize-pane -D
bind -r -T prefix   H    resize-pane -L
bind -r -T prefix   L    resize-pane -R

# Clear screen
bind -n F8 send-keys "clear"\; send-keys "Enter"

# Set vi-mode
set-window-option -g mode-keys vi

# Splits
bind v split-window -h -c "#{pane_current_path}"
bind V split-window -v -c "#{pane_current_path}"

## move the current pane to a new window positioned to the right of the current one
bind-key M break-pane \; move-window -t +1 \; swap-window -t -1


### PLUGINS ###
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'aserowy/tmux.nvim'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'omerxx/tmux-sessionx'

# Session restore
set -g @continuum-restore 'on'

# Session management
set -g @sessionx-bind 'o'

## process completion detection ##
set-option -wg monitor-activity off     # No activity monitoring
set-option -wg monitor-silence 0        # No silence monitoring  
set-option -g bell-action none          # No focus stealing on bells
set-option -g visual-activity off       # No popups
set-option -g visual-bell off           # No popups  
set-option -g visual-silence off        # No popups
set-option -g activity-action none      # No activity actions
set-option -g silence-action none       # No silence actions

# Result: Clean status bar with no annoying green highlights

### THEME SETTINGS ###

# window separators
set-option -wg window-status-separator ""

# monitor window changes (minimal - only explicit bells, no automatic highlighting)
set-option -wg monitor-bell on          # Only for explicit completion signals

# set statusbar update interval
set-option -g status-interval 1

### colorscheme ###
# change window screen colors
set-option -wg mode-style bg="#5a524c",fg="#5a524c"

# set-option -g status-position top
set-option -g status-style bg=terminal,fg="#4f4743"

# default window title colors
# set-option -wg window-status-style bg="#5a524c",fg="#cfcbcb" # lighter version
set-option -wg window-status-style bg="#3c3836",fg="#988b79"
set-option -wg window-status-format "#{?window_zoomed_flag,#[fg="#c8955e"],#[fg=default]} #{window_index} #{window_name} "

# active window title colors
# set-option -wg window-status-current-style bg="#e2cca9",fg="#3c3836"
set-option -wg window-status-current-style bg="#5a524c",fg="#fe8019"
set-option -wg window-status-current-format "#[fg=default] #{window_index} #{window_name} "

# colors for windows with activity (COMPLETELY REMOVED - no green highlights)
# set-option -wg window-status-activity-style bg="#8db583",fg="#24221c",bold

# colors for windows with bells (yellow - only for explicit completion signals)  
# set-option -wg window-status-bell-style bg="#d4b07b",fg="#24221c",bold

# pane border
set-option -g pane-active-border-style fg="#a99a85"
set-option -g pane-border-style fg="#3c3836" 

# message info 
set-option -g message-style bg="#d4b07b",fg="#3c3836"

# writing commands inactive
set-option -g message-command-style bg="#4f4743",fg="#3c3836"

# pane number display
set-option -g display-panes-active-colour "#d4b07b"
set-option -g display-panes-colour "#3c3836"

# clock
set-option -wg clock-mode-colour "#d4b07b"

# copy mode highlighting
%if #{>=:#{version},3.2}
    set-option -wg copy-mode-match-style "bg=#a89984,fg=#3c3836"
    set-option -wg copy-mode-current-match-style "bg=#d4b07b,fg=#3c3836"
%endif

# statusbar formatting
# "#d4b07b" MUST be in lowercase here (conflicts with statusline alias otherwise)
set -g status-bg "#24221c"
# first bg-fg pair corresponds to tmux-mode color [leader pressed]
set-option -g status-left "#[bg=#393533, fg=#24221c bold]#{?client_prefix,#[bg=#d4b07b],#[bg=#a89984, fg=#24221c bold]} #{session_name} "
set-option -g status-right "#[bg=#393533, fg=#cfbb9a] %H:%M #[bg=#a89984, fg=#3c3836]"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
